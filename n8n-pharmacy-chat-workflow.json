{
  "name": "farmacia-vanaci-advanced",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "chat",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "id": "625a0c49-7cb9-4b91-920f-aa12ed951292",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [0, 0],
      "webhookId": "pharmacy-chat"
    },
    {
      "parameters": {
        "jsCode": "// Process incoming chat request\nconst userMessage = $input.first().json.message;\nconst chatHistory = $input.first().json.chatHistory || [];\nconst sessionId = $input.first().json.sessionId || `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\n// Create system prompt for main AI Agent\nconst systemPrompt = `You are the Main AI Agent for "Farmácia Vanaci", a modern pharmacy e-commerce platform. You are the central coordinator that understands customer intentions and delegates tasks to specialized AI agents through tools.

**Your Role as Main Coordinator:**
- Analyze customer messages and determine which specialized tool/agent to use
- Maintain conversation flow and context across all interactions
- Provide friendly, professional pharmacy assistance
- Synthesize responses from specialized agents into coherent customer communication

**Available Specialized AI Agent Tools:**

1. **ProductSearchTool** - Specialized AI Agent for Product Discovery
   - Handles: Product searches, availability checks, price inquiries, specifications
   - Use when: Customer asks about medications, health products, prices, or product details
   - This agent will make HTTP calls to the product database and return structured information

2. **CartManagementTool** - Specialized AI Agent for Shopping Cart Operations
   - Handles: Adding/removing items, quantity updates, cart viewing, cart management
   - Use when: Customer wants to modify their shopping cart in any way
   - This agent manages session-based cart operations and returns cart status

3. **CheckoutTool** - Specialized AI Agent for Order Processing
   - Handles: Order finalization, payment processing, order confirmation
   - Use when: Customer is ready to complete their purchase
   - This agent processes the entire checkout flow and returns order details

**Pharmacy Information:**
- Name: Farmácia Vanaci
- Platform: https://vanaci-task-2.vercel.app
- Specializes in: Medications, health products, wellness items
- Session ID: ${sessionId}

**Coordination Guidelines:**
- Always determine customer intent before selecting tools
- Use appropriate specialized agents for their specific domains
- Maintain professional, empathetic tone in all communications
- Provide clear explanations and medical disclaimers when needed
- Synthesize agent responses into natural conversation flow

**Important Medical Disclaimers:**
- You cannot diagnose conditions or prescribe medications
- For prescription drugs, customers must consult licensed pharmacists
- Always recommend consulting healthcare professionals for medical advice
- In emergencies, direct customers to emergency services

**Current Context:**
Customer message: "${userMessage}"
Session ID: ${sessionId}

Analyze the customer's intent and use the appropriate specialized agent tool to help them.`;\n\nreturn {\n  userMessage,\n  chatHistory,\n  sessionId,\n  systemPrompt,\n  baseUrl: 'https://vanaci-task-2.vercel.app/api'\n};"
      },
      "id": "55e198fe-1799-4cef-bef2-27cdd0b212d6",
      "name": "Process Input",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [300, 0]
    },
    {
      "parameters": {
        "sessionIdKey": "sessionId",
        "contextWindowSize": 10
      },
      "id": "memory-node-12345",
      "name": "Simple Memory",
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1,
      "position": [500, 200]
    },
    {
      "parameters": {
        "options": {
          "systemMessage": "={{ $json.systemPrompt }}"
        }
      },
      "id": "bb995adb-c3cf-4b1b-b8c1-d16d4025ef1f",
      "name": "Main AI Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1,
      "position": [600, 0]
    },
    {
      "parameters": {
        "name": "ProductSearchTool",
        "description": "Specialized AI Agent for product discovery and information. This agent handles all product-related queries including searches, availability checks, price inquiries, and detailed product specifications. It makes HTTP calls to the product database and returns structured product information. Use this when customers ask about medications, health products, prices, availability, or any product-related questions.",
        "method": "GET",
        "url": "=https://vanaci-task-2.vercel.app/api/products",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "search",
              "value": "={{ $fromAI('query', 'Search term or product name') }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "f8e7d6c5-b4a3-9281-c7e6-f5d4e3c2b1a0",
      "name": "ProductSearchTool",
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1,
      "position": [800, -200]
    },
    {
      "parameters": {
        "name": "CartManagementTool",
        "description": "Specialized AI Agent for shopping cart management. This agent handles all cart-related operations including adding items, removing items, updating quantities, and viewing cart contents. It manages session-based cart operations and maintains cart state across the customer's shopping session. Use this when customers want to modify their shopping cart in any way or check their current cart status.",
        "method": "POST",
        "url": "=https://vanaci-task-2.vercel.app/api/cart/{{ $fromAI('action', 'Cart operation: add, remove, update, or view') }}",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "productId",
              "value": "={{ $fromAI('productId', 'Product ID for add/remove/update operations') }}"
            },
            {
              "name": "quantity",
              "value": "={{ $fromAI('quantity', 'Quantity for add/update operations') }}"
            },
            {
              "name": "sessionId",
              "value": "={{ $('Process Input').first().json.sessionId }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "a9b8c7d6-e5f4-3210-9876-543210fedcba",
      "name": "CartManagementTool",
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1,
      "position": [800, 0]
    },
    {
      "parameters": {
        "name": "CheckoutTool",
        "description": "Specialized AI Agent for order processing and checkout. This agent handles the complete checkout flow including order finalization, payment processing, and order confirmation. It processes customer information, validates cart contents, handles payment methods, and generates order confirmations. Use this when customers are ready to complete their purchase and finalize their order.",
        "method": "POST",
        "url": "=https://vanaci-task-2.vercel.app/api/checkout",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "sessionId",
              "value": "={{ $('Process Input').first().json.sessionId }}"
            },
            {
              "name": "customerInfo",
              "value": "={{ $fromAI('customerInfo', 'Customer details object with name, email, and address') }}"
            },
            {
              "name": "paymentMethod",
              "value": "={{ $fromAI('paymentMethod', 'Payment method selection', 'credit_card') }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "1a2b3c4d-5e6f-7890-abcd-ef1234567890",
      "name": "CheckoutTool",
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1,
      "position": [800, 200]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Process Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Input": {
      "main": [
        [
          {
            "node": "Main AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "Main AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "ProductSearchTool": {
      "ai_tool": [
        [
          {
            "node": "Main AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "CartManagementTool": {
      "ai_tool": [
        [
          {
            "node": "Main AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "CheckoutTool": {
      "ai_tool": [
        [
          {
            "node": "Main AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2024-01-15T10:30:00.000Z",
  "versionId": "1"
}
