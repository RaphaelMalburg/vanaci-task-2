{
  "name": "farmacia-vanaci-chat-workflow",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "farmacia-chat",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        912,
        432
      ],
      "id": "webhook-entrada",
      "name": "üåê Webhook Entrada",
      "webhookId": "farmacia-chat-webhook"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.body.sessionId }}",
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        1280,
        656
      ],
      "id": "reescritor-memory",
      "name": "üíæ Reescritor Memory"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.body.message }}",
        "options": {
          "systemMessage": "Voc√™ √© um Agente de Clareza de Mensagens para uma farm√°cia. Sua principal fun√ß√£o √© reescrever e expandir as mensagens curtas ou amb√≠guas dos clientes para torn√°-las mais compreens√≠veis e interpret√°veis, mantendo sempre a inten√ß√£o original.\n\nSeu objetivo √© garantir que cada comunica√ß√£o do cliente seja inequ√≠voca, como se o cliente tivesse falado de forma completa e detalhada desde o in√≠cio.\n\nRegras Essenciais:\n\n1. Preservar a Inten√ß√£o: Nunca altere o significado ou a inten√ß√£o por tr√°s da mensagem original do cliente.\n2. Contexto de Farm√°cia: As intera√ß√µes ser√£o sobre medicamentos, produtos farmac√™uticos, carrinho de compras, etc.\n3. Expans√£o Consciente:\n   - Afirma√ß√µes Curtas: Se o cliente disser \"sim\", \"quero\", \"ok\", expanda para algo como \"Sim, eu quero isso\".\n   - Pedidos Espec√≠ficos: Se o cliente mencionar apenas um medicamento, adicione contexto. Ex: \"dipirona\" deve ser \"Eu gostaria de comprar dipirona\".\n   - Negativas: Se o cliente disser \"n√£o\", expanda para \"N√£o, eu n√£o quero isso\".\n\n4. Linguagem Natural e Profissional: As mensagens reescritas devem soar naturais e manter um tom profissional.\n\nExemplos:\n- Cliente: \"sim\" ‚Üí \"Sim, eu quero isso.\"\n- Cliente: \"dipirona\" ‚Üí \"Eu estou procurando dipirona.\"\n- Cliente: \"adicionar carrinho\" ‚Üí \"Eu gostaria de adicionar este produto ao carrinho.\"\n\nSua tarefa √© receber a mensagem do cliente e fornecer apenas a vers√£o reescrita e clara dessa mensagem."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        1328,
        432
      ],
      "id": "reescritor-agente",
      "name": "‚úçÔ∏è Reescritor"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('üåê Webhook Entrada').item.json.body.sessionId }}",
        "contextWindowLength": 25
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        1904,
        608
      ],
      "id": "orquestrador-memory",
      "name": "üíæ Orquestrador Memory"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('üåê Webhook Entrada').item.json.body.message }}",
        "options": {
          "systemMessage": "Voc√™ √© o agente principal da Farm√°cia Vanaci\n\n# TODAS AS REQUESTS PRECISAM PASSAR O SESSION ID COMO PAR√ÇMETRO NO BODY, O SESSION ID √â EXCLUSIVAMENTE ESSE {{ $('üåê Webhook Entrada').item.json.body.sessionId }}\n\n# CASO VOC√ä N√ÉO PASSE O SESSION ID {{ $('üåê Webhook Entrada').item.json.body.sessionId }} EM TODAS AS FERRAMENTAS HTTP, O SISTEMA VAI FALHAR\n\n## Use a ferramenta 'Buscar Produtos' para buscar medicamentos, suplementos e produtos farmac√™uticos quando o cliente quiser informa√ß√µes sobre produtos, pre√ßos, disponibilidade\n\n## Use a ferramenta 'Gerenciar Carrinho' para adicionar, remover ou visualizar itens no carrinho quando o cliente quiser gerenciar seu carrinho de compras\n\n## Use a ferramenta 'Finalizar Compra' para processar checkout e finalizar pedidos quando o cliente quiser finalizar a compra\n\n## Use a ferramenta 'Navega√ß√£o Site' para ajudar o cliente a navegar pelo site, encontrar se√ß√µes espec√≠ficas ou orienta√ß√µes gerais\n\n## Use a ferramenta 'Remover Itens' para remover produtos espec√≠ficos do carrinho com confirma√ß√µes de seguran√ßa\n\n# Nunca pe√ßa o session id para o cliente, n√£o pe√ßa login do usu√°rio\n\n# SEMPRE MANDE O SESSION ID {{ $('üåê Webhook Entrada').item.json.body.sessionId }} COMO PAR√ÇMETRO EM TODAS AS REQUISI√á√ïES\n\n# Seja profissional, atencioso e focado em sa√∫de e bem-estar dos clientes"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        2224,
        432
      ],
      "id": "orquestrador-principal",
      "name": "üè• Farm√°cia Orquestrador",
      "retryOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:3000/api/chat-response",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "text",
              "value": "={{ $json.output }}"
            },
            {
              "name": "sessionId",
              "value": "={{ $('üåê Webhook Entrada').item.json.body.sessionId }}"
            }
          ]
        },
        "options": {
          "allowUnauthorizedCerts": true
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2608,
        432
      ],
      "id": "resposta-final",
      "name": "üì§ Resposta Final"
    },
    {
      "parameters": {
        "toolDescription": "Buscar produtos farmac√™uticos",
        "method": "GET",
        "url": "http://localhost:3000/api/products",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "search",
              "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('search', 'Termo de busca do produto', 'string') }}"
            },
            {
              "name": "sessionId",
              "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('sessionId', 'ID da sess√£o', 'string') }}"
            }
          ]
        },
        "options": {
          "allowUnauthorizedCerts": true
        }
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        2784,
        800
      ],
      "id": "buscar-produtos-tool",
      "name": "üîç Buscar Produtos"
    },
    {
      "parameters": {
        "toolDescription": "Gerenciar carrinho de compras",
        "method": "POST",
        "url": "http://localhost:3000/api/cart",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "action",
              "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('action', 'A√ß√£o: add, remove, view', 'string') }}"
            },
            {
              "name": "productId",
              "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('productId', 'ID do produto', 'string') }}"
            },
            {
              "name": "quantity",
              "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('quantity', 'Quantidade', 'number') }}"
            },
            {
              "name": "sessionId",
              "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('sessionId', 'ID da sess√£o', 'string') }}"
            }
          ]
        },
        "options": {
          "allowUnauthorizedCerts": true
        }
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        2784,
        960
      ],
      "id": "gerenciar-carrinho-tool",
      "name": "üõí Gerenciar Carrinho"
    },
    {
      "parameters": {
        "toolDescription": "Finalizar compra e checkout",
        "method": "POST",
        "url": "http://localhost:3000/api/checkout",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "sessionId",
              "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('sessionId', 'ID da sess√£o', 'string') }}"
            }
          ]
        },
        "options": {
          "allowUnauthorizedCerts": true
        }
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        2784,
        1120
      ],
      "id": "finalizar-compra-tool",
      "name": "üí≥ Finalizar Compra"
    },
    {
      "parameters": {
        "toolDescription": "Navega√ß√£o e orienta√ß√µes no site",
        "method": "GET",
        "url": "http://localhost:3000/api/navigation",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "section",
              "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('section', 'Se√ß√£o do site', 'string') }}"
            },
            {
              "name": "sessionId",
              "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('sessionId', 'ID da sess√£o', 'string') }}"
            }
          ]
        },
        "options": {
          "allowUnauthorizedCerts": true
        }
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        2784,
        1280
      ],
      "id": "navegacao-site-tool",
      "name": "üß≠ Navega√ß√£o Site"
    },
    {
      "parameters": {
        "toolDescription": "Remover itens espec√≠ficos do carrinho",
        "method": "DELETE",
        "url": "http://localhost:3000/api/cart/remove",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "productId",
              "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('productId', 'ID do produto a remover', 'string') }}"
            },
            {
              "name": "sessionId",
              "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('sessionId', 'ID da sess√£o', 'string') }}"
            }
          ]
        },
        "options": {
          "allowUnauthorizedCerts": true
        }
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        2784,
        1440
      ],
      "id": "remover-itens-tool",
      "name": "üóëÔ∏è Remover Itens"
    },
    {
      "parameters": {
        "model": "mistral-large-latest",
        "options": {
          "temperature": 0.3,
          "maxTokens": 800
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        1600,
        656
      ],
      "id": "reescritor-llm",
      "name": "üß† Reescritor LLM"
    },
    {
      "parameters": {
        "model": "mistral-large-latest",
        "options": {
          "temperature": 0.4,
          "maxTokens": 1000
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        2400,
        608
      ],
      "id": "orquestrador-llm",
      "name": "üß† Orquestrador LLM"
    }
  ],
  "connections": {
    "üåê Webhook Entrada": {
      "main": [
        [
          {
            "node": "‚úçÔ∏è Reescritor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚úçÔ∏è Reescritor": {
      "main": [
        [
          {
            "node": "üè• Farm√°cia Orquestrador",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üè• Farm√°cia Orquestrador": {
      "main": [
        [
          {
            "node": "üì§ Resposta Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üíæ Reescritor Memory": {
      "ai_memory": [
        [
          {
            "node": "‚úçÔ∏è Reescritor",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "üß† Reescritor LLM": {
      "ai_languageModel": [
        [
          {
            "node": "‚úçÔ∏è Reescritor",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "üíæ Orquestrador Memory": {
      "ai_memory": [
        [
          {
            "node": "üè• Farm√°cia Orquestrador",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "üß† Orquestrador LLM": {
      "ai_languageModel": [
        [
          {
            "node": "üè• Farm√°cia Orquestrador",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "üîç Buscar Produtos": {
      "ai_tool": [
        [
          {
            "node": "üè• Farm√°cia Orquestrador",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "üõí Gerenciar Carrinho": {
      "ai_tool": [
        [
          {
            "node": "üè• Farm√°cia Orquestrador",
            "type": "ai_tool",
            "index": 1
          }
        ]
      ]
    },
    "üí≥ Finalizar Compra": {
      "ai_tool": [
        [
          {
            "node": "üè• Farm√°cia Orquestrador",
            "type": "ai_tool",
            "index": 2
          }
        ]
      ]
    },
    "üß≠ Navega√ß√£o Site": {
      "ai_tool": [
        [
          {
            "node": "üè• Farm√°cia Orquestrador",
            "type": "ai_tool",
            "index": 3
          }
        ]
      ]
    },
    "üóëÔ∏è Remover Itens": {
      "ai_tool": [
        [
          {
            "node": "üè• Farm√°cia Orquestrador",
            "type": "ai_tool",
            "index": 4
          }
        ]
      ]
    }
  },
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "farmacia-vanaci-workflow-instance"
  }
}
