2025-09-10T14:39:20.139Z [info] Warning: NODE_ENV was incorrectly set to "development", this value is being overridden to "production"
2025-09-10T14:39:20.528Z [info] 🚀 API ai-chat: Recebendo requisição POST
2025-09-10T14:39:20.532Z [info] 📦 Dados recebidos: {
  "message": "estou com dor no joelho o que tomo",
  "sessionId": "session_1756746412255_oi9mxcmg9",
  "streaming": true,
  "context": {
    "userId": "cmfb78cp700kajs04o2qj38yz",
    "user": {
      "id": "cmfb78cp700kajs04o2qj38yz",
      "username": "raphael"
    }
  },
  "chatHistory": [
    {
      "role": "assistant",
      "content": "Olá! Sou seu assistente virtual da farmácia. Como posso ajudá-lo hoje?"
    }
  ]
}
2025-09-10T14:39:20.532Z [info] 👤 User ID extraído do contexto: cmfb78cp700kajs04o2qj38yz
2025-09-10T14:39:20.532Z [info] 🆔 Session ID: session_1756746412255_oi9mxcmg9
2025-09-10T14:39:20.532Z [info] 📝 Mensagem: estou com dor no joelho o que tomo
2025-09-10T14:39:20.533Z [info] 🔄 Streaming habilitado: true
2025-09-10T14:39:20.533Z [info] ⚙️ Configuração LLM: { provider: 'openai', temperature: 0.7, maxTokens: 2000 }
2025-09-10T14:39:20.533Z [info] 🤖 Criando instância do agente...
2025-09-10T14:39:20.534Z [info] ✅ Agente criado com sucesso
2025-09-10T14:39:20.534Z [info] 🌊 Iniciando processamento com streaming...
2025-09-10T14:39:20.535Z [info] 🎯 StreamMessage iniciado para sessão: session_1756746412255_oi9mxcmg9
2025-09-10T14:39:20.535Z [info] 💬 Mensagem original do usuário: estou com dor no joelho o que tomo
2025-09-10T14:39:20.535Z [info] 🔧 Contexto fornecido: {
  userId: 'cmfb78cp700kajs04o2qj38yz',
  user: { id: 'cmfb78cp700kajs04o2qj38yz', username: 'raphael' }
}
2025-09-10T14:39:23.033Z [info] 🔧 [Global Context] sessionId definido: session_1756746412255_oi9mxcmg9
2025-09-10T14:39:23.033Z [info] 🔧 [Global Context] userId definido: cmfb78cp700kajs04o2qj38yz
2025-09-10T14:39:23.033Z [info] 🔧 [Global Context] user definido: { id: 'cmfb78cp700kajs04o2qj38yz', username: 'raphael' }
2025-09-10T14:39:38.143Z [info] 📡 Stream result obtido: true
2025-09-10T14:39:38.143Z [info] 🚀 Iniciando stream para sessão: session_1756746412255_oi9mxcmg9
2025-09-10T14:39:38.143Z [info] 📡 Stream result obtido: true
2025-09-10T14:39:38.144Z [info] 📡 Stream result keys: [
  '_totalUsage',
  '_finishReason',
  '_steps',
  'output',
  'includeRawChunks',
  'tools',
  'addStream',
  'closeStream',
  'baseStream'
]
2025-09-10T14:39:38.144Z [info] 🔧 Tool calls promise detectado no resultado inicial
2025-09-10T14:39:38.146Z [info] 🔧 Tool calls no resultado inicial: 1
2025-09-10T14:39:38.146Z [info] 🛠️ Tool Call 0: {
  toolName: 'list_recommended_products',
  toolCallId: 'call_FYIccdTyaw3gb4DJa1qvqtvj'
}
2025-09-10T14:39:38.146Z [info] 🌊 Iniciando iteração do fullStream...
2025-09-10T14:39:38.147Z [info] 🔄 Processando chunk 1 do fullStream: { type: 'start', hasText: false, hasToolCall: false, chunkData: 'N/A' }
2025-09-10T14:39:38.148Z [info] ❓ Chunk tipo desconhecido: start { type: 'start' }
2025-09-10T14:39:38.148Z [info] 🔄 Processando chunk 2 do fullStream: {
  type: 'start-step',
  hasText: false,
  hasToolCall: false,
  chunkData: 'N/A'
}
2025-09-10T14:39:38.149Z [info] ❓ Chunk tipo desconhecido: start-step {
  type: 'start-step',
  request: {
    body: {
      model: 'gpt-5-nano',
      input: [Array],
      temperature: undefined,
      top_p: undefined,
      max_output_tokens: undefined,
      metadata: undefined,
      parallel_tool_calls: undefined,
      previous_response_id: undefined,
      store: undefined,
      user: undefined,
      instructions: undefined,
      service_tier: undefined,
      include: undefined,
      prompt_cache_key: undefined,
      safety_identifier: undefined,
      top_logprobs: undefined,
      tools: [Array],
      tool_choice: 'required'
    }
  },
  warnings: [
    {
      type: 'unsupported-setting',
      setting: 'temperature',
      details: 'temperature is not supported for reasoning models'
    }
  ]
}
2025-09-10T14:39:38.150Z [info] 🔄 Processando chunk 3 do fullStream: {
  type: 'reasoning-start',
  hasText: false,
  hasToolCall: false,
  chunkData: 'N/A'
}
2025-09-10T14:39:38.150Z [info] ❓ Chunk tipo desconhecido: reasoning-start {
  type: 'reasoning-start',
  id: 'rs_68c18d9cc8ec819599dbbda971b7b1a503382aa317611000:0',
  providerMetadata: {
    openai: {
      itemId: 'rs_68c18d9cc8ec819599dbbda971b7b1a503382aa317611000',
      reasoningEncryptedContent: null
    }
  }
}
2025-09-10T14:39:38.150Z [info] 🔄 Processando chunk 4 do fullStream: {
  type: 'reasoning-end',
  hasText: false,
  hasToolCall: false,
  chunkData: 'N/A'
}
2025-09-10T14:39:38.150Z [info] ❓ Chunk tipo desconhecido: reasoning-end {
  type: 'reasoning-end',
  id: 'rs_68c18d9cc8ec819599dbbda971b7b1a503382aa317611000:0',
  providerMetadata: {
    openai: {
      itemId: 'rs_68c18d9cc8ec819599dbbda971b7b1a503382aa317611000',
      reasoningEncryptedContent: null
    }
  }
}
2025-09-10T14:39:38.151Z [info] 🔄 Processando chunk 5 do fullStream: {
  type: 'tool-input-start',
  hasText: false,
  hasToolCall: false,
  chunkData: 'N/A'
}
2025-09-10T14:39:38.151Z [info] ❓ Chunk tipo desconhecido: tool-input-start {
  type: 'tool-input-start',
  id: 'call_FYIccdTyaw3gb4DJa1qvqtvj',
  toolName: 'list_recommended_products',
  dynamic: false
}
2025-09-10T14:39:38.151Z [info] 🔄 Processando chunk 6 do fullStream: {
  type: 'tool-input-delta',
  hasText: false,
  hasToolCall: false,
  chunkData: 'N/A'
}
2025-09-10T14:39:38.151Z [info] ❓ Chunk tipo desconhecido: tool-input-delta {
  type: 'tool-input-delta',
  id: 'call_FYIccdTyaw3gb4DJa1qvqtvj',
  delta: '{"'
}
2025-09-10T14:39:38.153Z [info] 🔄 Processando chunk 7 do fullStream: {
  type: 'tool-input-delta',
  hasText: false,
  hasToolCall: false,
  chunkData: 'N/A'
}
2025-09-10T14:39:38.153Z [info] ❓ Chunk tipo desconhecido: tool-input-delta {
  type: 'tool-input-delta',
  id: 'call_FYIccdTyaw3gb4DJa1qvqtvj',
  delta: 'sym'
}
2025-09-10T14:39:38.153Z [info] 🔄 Processando chunk 8 do fullStream: {
  type: 'tool-input-delta',
  hasText: false,
  hasToolCall: false,
  chunkData: 'N/A'
}
2025-09-10T14:39:38.153Z [info] ❓ Chunk tipo desconhecido: tool-input-delta {
  type: 'tool-input-delta',
  id: 'call_FYIccdTyaw3gb4DJa1qvqtvj',
  delta: 'ptom'
}
2025-09-10T14:39:38.153Z [info] 🔄 Processando chunk 9 do fullStream: {
  type: 'tool-input-delta',
  hasText: false,
  hasToolCall: false,
  chunkData: 'N/A'
}
2025-09-10T14:39:38.153Z [info] ❓ Chunk tipo desconhecido: tool-input-delta {
  type: 'tool-input-delta',
  id: 'call_FYIccdTyaw3gb4DJa1qvqtvj',
  delta: 'Or'
}
2025-09-10T14:39:38.153Z [info] 🔄 Processando chunk 10 do fullStream: {
  type: 'tool-input-delta',
  hasText: false,
  hasToolCall: false,
  chunkData: 'N/A'
}
2025-09-10T14:39:38.153Z [info] ❓ Chunk tipo desconhecido: tool-input-delta {
  type: 'tool-input-delta',
  id: 'call_FYIccdTyaw3gb4DJa1qvqtvj',
  delta: 'Need'
}
2025-09-10T14:39:38.153Z [info] 🔄 Processando chunk 11 do fullStream: {
  type: 'tool-input-delta',
  hasText: false,
  hasToolCall: false,
  chunkData: 'N/A'
}
2025-09-10T14:39:38.153Z [info] ❓ Chunk tipo desconhecido: tool-input-delta {
  type: 'tool-input-delta',
  id: 'call_FYIccdTyaw3gb4DJa1qvqtvj',
  delta: '":"'
}
2025-09-10T14:39:38.154Z [info] 🔄 Processando chunk 12 do fullStream: {
  type: 'tool-input-delta',
  hasText: false,
  hasToolCall: false,
  chunkData: 'N/A'
}
2025-09-10T14:39:38.154Z [info] ❓ Chunk tipo desconhecido: tool-input-delta {
  type: 'tool-input-delta',
  id: 'call_FYIccdTyaw3gb4DJa1qvqtvj',
  delta: 'dor'
}
2025-09-10T14:39:38.154Z [info] 🔄 Processando chunk 13 do fullStream: {
  type: 'tool-input-delta',
  hasText: false,
  hasToolCall: false,
  chunkData: 'N/A'
}
2025-09-10T14:39:38.154Z [info] ❓ Chunk tipo desconhecido: tool-input-delta {
  type: 'tool-input-delta',
  id: 'call_FYIccdTyaw3gb4DJa1qvqtvj',
  delta: ' no'
}
2025-09-10T14:39:38.155Z [info] 🔄 Processando chunk 14 do fullStream: {
  type: 'tool-input-delta',
  hasText: false,
  hasToolCall: false,
  chunkData: 'N/A'
}
2025-09-10T14:39:38.155Z [info] ❓ Chunk tipo desconhecido: tool-input-delta {
  type: 'tool-input-delta',
  id: 'call_FYIccdTyaw3gb4DJa1qvqtvj',
  delta: ' jo'
}
2025-09-10T14:39:38.155Z [info] 🔄 Processando chunk 15 do fullStream: {
  type: 'tool-input-delta',
  hasText: false,
  hasToolCall: false,
  chunkData: 'N/A'
}
2025-09-10T14:39:38.155Z [info] ❓ Chunk tipo desconhecido: tool-input-delta {
  type: 'tool-input-delta',
  id: 'call_FYIccdTyaw3gb4DJa1qvqtvj',
  delta: 'elho'
}
2025-09-10T14:39:38.156Z [info] 🔄 Processando chunk 16 do fullStream: {
  type: 'tool-input-delta',
  hasText: false,
  hasToolCall: false,
  chunkData: 'N/A'
}
2025-09-10T14:39:38.156Z [info] ❓ Chunk tipo desconhecido: tool-input-delta {
  type: 'tool-input-delta',
  id: 'call_FYIccdTyaw3gb4DJa1qvqtvj',
  delta: '","'
}
2025-09-10T14:39:38.156Z [info] 🔄 Processando chunk 17 do fullStream: {
  type: 'tool-input-delta',
  hasText: false,
  hasToolCall: false,
  chunkData: 'N/A'
}
2025-09-10T14:39:38.156Z [info] ❓ Chunk tipo desconhecido: tool-input-delta {
  type: 'tool-input-delta',
  id: 'call_FYIccdTyaw3gb4DJa1qvqtvj',
  delta: 'limit'
}
2025-09-10T14:39:38.156Z [info] 🔄 Processando chunk 18 do fullStream: {
  type: 'tool-input-delta',
  hasText: false,
  hasToolCall: false,
  chunkData: 'N/A'
}
2025-09-10T14:39:38.156Z [info] ❓ Chunk tipo desconhecido: tool-input-delta {
  type: 'tool-input-delta',
  id: 'call_FYIccdTyaw3gb4DJa1qvqtvj',
  delta: '":'
}
2025-09-10T14:39:38.157Z [info] 🔄 Processando chunk 19 do fullStream: {
  type: 'tool-input-delta',
  hasText: false,
  hasToolCall: false,
  chunkData: 'N/A'
}
2025-09-10T14:39:38.157Z [info] ❓ Chunk tipo desconhecido: tool-input-delta {
  type: 'tool-input-delta',
  id: 'call_FYIccdTyaw3gb4DJa1qvqtvj',
  delta: '5'
}
2025-09-10T14:39:38.157Z [info] 🔄 Processando chunk 20 do fullStream: {
  type: 'tool-input-delta',
  hasText: false,
  hasToolCall: false,
  chunkData: 'N/A'
}
2025-09-10T14:39:38.157Z [info] ❓ Chunk tipo desconhecido: tool-input-delta {
  type: 'tool-input-delta',
  id: 'call_FYIccdTyaw3gb4DJa1qvqtvj',
  delta: '}'
}
2025-09-10T14:39:38.158Z [info] 🔄 Processando chunk 21 do fullStream: {
  type: 'tool-input-end',
  hasText: false,
  hasToolCall: false,
  chunkData: 'N/A'
}
2025-09-10T14:39:38.158Z [info] ❓ Chunk tipo desconhecido: tool-input-end { type: 'tool-input-end', id: 'call_FYIccdTyaw3gb4DJa1qvqtvj' }
2025-09-10T14:39:38.159Z [info] 🔄 Processando chunk 22 do fullStream: {
  type: 'tool-call',
  hasText: false,
  hasToolCall: true,
  chunkData: 'N/A'
}
2025-09-10T14:39:38.159Z [info] 🛠️ Processando tool call 1: {
  toolName: 'list_recommended_products',
  toolCallId: 'call_FYIccdTyaw3gb4DJa1qvqtvj',
  args: { symptomOrNeed: 'dor no joelho', limit: 5 },
  argsKeys: [ 'symptomOrNeed', 'limit' ]
}
2025-09-10T14:39:38.159Z [info] 📤 Enviando tool call data: {"type":"tool_call","toolCall":{"type":"tool-call","toolCallId":"call_FYIccdTyaw3gb4DJa1qvqtvj","toolName":"list_recommended_products","input":{"symptomOrNeed":"dor no joelho","limit":5},"providerMeta...
2025-09-10T14:39:38.161Z [info] ✅ Tool call 1 enviado com sucesso
2025-09-10T14:39:38.162Z [info] 🔄 Processando chunk 23 do fullStream: {
  type: 'tool-result',
  hasText: false,
  hasToolCall: false,
  chunkData: 'N/A'
}
2025-09-10T14:39:38.162Z [info] 🔧 Tool result recebido para call_FYIccdTyaw3gb4DJa1qvqtvj: {
  toolCallId: 'call_FYIccdTyaw3gb4DJa1qvqtvj',
  result: 'ausente',
  resultType: 'undefined'
}
2025-09-10T14:39:38.162Z [info] 📤 Enviando tool result data para call_FYIccdTyaw3gb4DJa1qvqtvj
2025-09-10T14:39:38.162Z [info] ✅ Tool result enviado com sucesso para call_FYIccdTyaw3gb4DJa1qvqtvj
2025-09-10T14:39:38.162Z [info] 🔄 Processando chunk 24 do fullStream: {
  type: 'finish-step',
  hasText: false,
  hasToolCall: false,
  chunkData: 'N/A'
}
2025-09-10T14:39:38.162Z [info] ❓ Chunk tipo desconhecido: finish-step {
  type: 'finish-step',
  finishReason: 'tool-calls',
  usage: {
    inputTokens: 7017,
    outputTokens: 608,
    totalTokens: 7625,
    reasoningTokens: 576,
    cachedInputTokens: 0
  },
  providerMetadata: {
    openai: {
      responseId: 'resp_68c18d9b74f881959e3ff49d120ec46b03382aa317611000'
    }
  },
  response: {
    id: 'resp_68c18d9b74f881959e3ff49d120ec46b03382aa317611000',
    timestamp: 2025-09-10T14:39:23.000Z,
    modelId: 'gpt-5-nano-2025-08-07',
    headers: {
      'alt-svc': 'h3=":443"; ma=86400',
      'cf-cache-status': 'DYNAMIC',
      'cf-ray': '97cfaca96cdd9388-IAD',
      connection: 'keep-alive',
      'content-type': 'text/event-stream; charset=utf-8',
      date: 'Wed, 10 Sep 2025 14:39:23 GMT',
      'openai-organization': 'vanaciprime',
      'openai-processing-ms': '515',
      'openai-project': 'proj_mK94ke9oHqgykXFfyMAf8tOb',
      'openai-version': '2020-10-01',
      server: 'cloudflare',
      'set-cookie': '_cfuvid=Zv4Hl7gwGMs6zYJ6QXTVFLBDCXebInygcSk95Ca6tFQ-1757515163970-0.0.1.1-604800000; path=/; domain=.api.openai.com; HttpOnly; Secure; SameSite=None',
      'strict-transport-security': 'max-age=31536000; includeSubDomains; preload',
      'transfer-encoding': 'chunked',
      'x-content-type-options': 'nosniff',
      'x-envoy-upstream-service-time': '584',
      'x-request-id': 'req_bb4cd34a40a04bc8b2f78cd8033db08d'
    }
  }
}
2025-09-10T14:39:38.162Z [info] 🔄 Processando chunk 25 do fullStream: {
  type: 'finish',
  hasText: false,
  hasToolCall: false,
  chunkData: 'N/A'
}
2025-09-10T14:39:38.163Z [info] ❓ Chunk tipo desconhecido: finish {
  type: 'finish',
  finishReason: 'tool-calls',
  totalUsage: {
    inputTokens: 7017,
    outputTokens: 608,
    totalTokens: 7625,
    reasoningTokens: 576,
    cachedInputTokens: 0
  }
}
2025-09-10T14:39:38.163Z [info] 📊 Total de chunks de texto processados: 0
2025-09-10T14:39:38.163Z [info] 📊 Total de tool calls processados: 1
2025-09-10T14:39:38.163Z [info] 🔧 Tool calls foram processados: true
2025-09-10T14:39:38.163Z [info] 📊 Total de chunks processados: 25
2025-09-10T14:39:38.163Z [info] 🔄 Implementando solução híbrida: forçando resposta textual após tool calls
2025-09-10T14:39:39.850Z [info] 🔧 [Global Context] sessionId definido: session_1756746412255_oi9mxcmg9
2025-09-10T14:39:39.850Z [info] 🔧 [Global Context] userId definido: cmfb78cp700kajs04o2qj38yz
2025-09-10T14:39:39.850Z [info] 🔧 [Global Context] user definido: { id: 'cmfb78cp700kajs04o2qj38yz', username: 'raphael' }
2025-09-10T14:40:06.551Z [info] ➕ Resposta do assistente adicionada à sessão
2025-09-10T14:40:06.551Z [info] 🗂️ Histórico limitado a 20 mensagens
2025-09-10T14:40:06.551Z [info] ✅ ProcessMessage concluído com sucesso
2025-09-10T14:40:06.551Z [info] 📝 Resposta textual forçada gerada: Resumo objetivo do que foi feito
- Buscamos opções seguras e comuns para aliviar dor no joelho.
- Li...
2025-09-10T14:40:06.551Z [info] 🏁 Finalizando stream
2025-09-10T14:40:06.551Z [info] ✅ Stream finalizado com sucesso
